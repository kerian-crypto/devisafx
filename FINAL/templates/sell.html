{% extends "base.html" %}

{% block title %}Vendre USDT - Devisa-FX{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Vendre des USDT</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.sell') }}" id="sell-form">
                    {{ form.hidden_tag() }}
                    
                    <!-- Montant en USDT -->
                    <div class="mb-4">
                        <label for="montant_usdt" class="form-label">Montant à vendre (USDT) *</label>
                        <div class="input-group">
                            {{ form.montant_usdt(class="form-control form-control-lg", placeholder="10", id="montant_usdt_input") }}
                            <span class="input-group-text">USDT</span>
                        </div>
                        <div class="form-text">
                            Montant minimum: 1 USDT | Maximum: 1000 USDT
                        </div>
                        {% if form.montant_usdt.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.montant_usdt.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Informations sur le taux -->
                    <div class="alert alert-info mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Taux d'achat actuel:</strong></p>
                                <h4 class="mb-0">{{ taux_achat }} XAF/USDT</h4>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Vous recevrez:</strong></p>
                                <h4 class="mb-0" id="montant_xaf_result">0 XAF</h4>
                                <input type="hidden" id="taux_achat" value="{{ taux_achat }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Réseau d'envoi -->
                    <div class="mb-4">
                        <label for="reseau" class="form-label">Réseau d'envoi *</label>
                        {{ form.reseau(class="form-select") }}
                        <div class="form-text">
                            Sélectionnez le réseau sur lequel vous enverrez les USDT
                        </div>
                        {% if form.reseau.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.reseau.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Adresse Wallet (optionnelle) -->
                    <div class="mb-4">
                        <label for="adresse_wallet" class="form-label">Votre adresse wallet (pour vérification)</label>
                        {{ form.adresse_wallet(class="form-control", placeholder="Optionnel - pour vérification") }}
                        {% if form.adresse_wallet.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.adresse_wallet.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Opérateur mobile de réception -->
                    <div class="mb-4">
                        <label for="operateur_mobile" class="form-label">Opérateur de réception *</label>
                        {{ form.operateur_mobile(class="form-select") }}
                        <div class="form-text">
                            Sélectionnez l'opérateur sur lequel vous recevrez les XAF
                        </div>
                        {% if form.operateur_mobile.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.operateur_mobile.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Numéro mobile pour réception -->
                    <div class="mb-4">
                        <label for="numero_mobile" class="form-label">Numéro mobile pour recevoir les XAF *</label>
                        {{ form.numero_mobile(class="form-control", placeholder="237612345678") }}
                        <div class="form-text">
                            Le numéro doit être associé à l'opérateur sélectionné
                        </div>
                        {% if form.numero_mobile.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.numero_mobile.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Conditions -->
                    <div class="mb-4 form-check">
                        <input type="checkbox" class="form-check-input" id="confirm_sell" required>
                        <label class="form-check-label" for="confirm_sell">
                            Je confirme que je vais envoyer exactement le montant indiqué en USDT sur l'adresse qui me sera fournie.
                        </label>
                    </div>
                    
                    <!-- Bouton de soumission -->
                    <div class="d-grid">
                        {{ form.soumettre(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
        <!-- Guide de vente -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Guide de vente
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">Remplissez le formulaire avec vos informations</li>
                    <li class="mb-2">Une adresse de réception vous sera attribuée</li>
                    <li class="mb-2">Envoyez EXACTEMENT le montant en USDT indiqué</li>
                    <li class="mb-2">Attendez la confirmation par notre équipe</li>
                    <li>Recevez les XAF sur votre compte mobile money</li>
                </ol>
                
                <div class="alert alert-danger mt-3">
                    <i class="fas fa-ban me-2"></i>
                    <strong>Attention :</strong> Tout envoi d'un montant différent sera rejeté et les fonds retenus.
                </div>
            </div>
        </div>
        
        <!-- Frais détaillés -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-percentage me-2"></i>Tableau des frais
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Montant USDT</th>
                            <th>Frais</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1 - 499 USDT</td>
                            <td>1.51%</td>
                        </tr>
                        <tr>
                            <td>500 - 999 USDT</td>
                            <td>10%</td>
                        </tr>
                        <tr>
                            <td>≥ 1000 USDT</td>
                            <td>Contactez-nous</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la vente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Vous êtes sur le point de vendre <strong id="confirm-sell-usdt">0.00</strong> USDT pour <strong id="confirm-sell-xaf">0</strong> XAF.</p>
                <p>Vous devrez envoyer les USDT à l'adresse qui vous sera fournie.</p>
                <p>Confirmez-vous cette transaction ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirm-sell">Confirmer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const montantUsdtInput = document.getElementById('montant_usdt_input');
    const tauxAchatInput = document.getElementById('taux_achat');
    const montantXafSpan = document.getElementById('montant_xaf_result');
    const sellForm = document.getElementById('sell-form');
    
    // Calcul automatique du montant XAF
    function calculateXAF() {
        const montantUsdt = parseFloat(montantUsdtInput.value) || 0;
        const tauxAchat = parseFloat(tauxAchatInput.value) || 600;
        const montantXaf = montantUsdt * tauxAchat;
        montantXafSpan.textContent = montantXaf.toLocaleString('fr-FR') + ' XAF';
    }
    
    montantUsdtInput.addEventListener('input', calculateXAF);
    
    // Confirmation avant soumission
    sellForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const montantUsdt = parseFloat(montantUsdtInput.value) || 0;
        const tauxAchat = parseFloat(tauxAchatInput.value) || 600;
        const montantXaf = montantUsdt * tauxAchat;
        
        if (montantUsdt < 1 || montantUsdt > 1000) {
            alert('Le montant doit être entre 1 et 1000 USDT');
            return;
        }
        
        // Mettre à jour le modal de confirmation
        document.getElementById('confirm-sell-usdt').textContent = montantUsdt.toFixed(2);
        document.getElementById('confirm-sell-xaf').textContent = montantXaf.toLocaleString('fr-FR');
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
    });
    
    // Confirmation finale
    document.getElementById('confirm-sell').addEventListener('click', function() {
        sellForm.submit();
    });
    
    // Calcul initial
    calculateXAF();
});
</script>

{% endblock %}
