{% extends "base.html" %}

{% block title %}Acheter USDT - Devisa-FX{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Acheter des USDT</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.buy') }}" id="buy-form">
                    {{ form.hidden_tag() }}
                    
                    <!-- Montant en XAF -->
                    <div class="mb-4">
                        <label for="montant_xaf" class="form-label">Montant à échanger (XAF) *</label>
                        <div class="input-group">
                            {{ form.montant_xaf(class="form-control form-control-lg", placeholder="5000", id="montant_xaf") }}
                            <span class="input-group-text">XAF</span>
                        </div>
                        <div class="form-text">
                            Montant minimum: 5,000 XAF | Maximum: 500,000 XAF
                        </div>
                        {% if form.montant_xaf.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.montant_xaf.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Informations sur le taux -->
                    <div class="alert alert-info mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Taux de vente actuel:</strong></p>
                                <h4 class="mb-0">{{ taux_vente }} XAF/USDT</h4>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Vous recevrez:</strong></p>
                                <h4 class="mb-0" id="montant_usdt">0.00 USDT</h4>
                                <input type="hidden" id="taux_vente" value="{{ taux_vente }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Adresse Wallet -->
                    <div class="mb-4">
                        <label for="adresse_wallet" class="form-label">Adresse de réception USDT *</label>
                        {{ form.adresse_wallet(class="form-control", placeholder="Txxxxxxxxx... ou 0x...", id="adresse_wallet") }}
                        <div class="form-text" id="network-help">
                            Commencez à taper votre adresse pour détecter automatiquement le réseau
                        </div>
                        {% if form.adresse_wallet.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.adresse_wallet.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Réseau (auto-détecté mais modifiable) -->
                    <div class="mb-4">
                        <label for="reseau" class="form-label">Réseau *</label>
                        {{ form.reseau(class="form-select", id="reseau") }}
                        <div class="form-text">
                            Assurez-vous que le réseau correspond à votre adresse de réception
                        </div>
                        {% if form.reseau.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.reseau.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Opérateur mobile -->
                    <div class="mb-4">
                        <label for="operateur_mobile" class="form-label">Opérateur mobile pour le paiement *</label>
                        {{ form.operateur_mobile(class="form-select") }}
                        <div class="form-text">
                            Sélectionnez l'opérateur avec lequel vous effectuerez le paiement
                        </div>
                        {% if form.operateur_mobile.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.operateur_mobile.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Conditions -->
                    <div class="mb-4 form-check">
                        <input type="checkbox" class="form-check-input" id="confirm_buy" required>
                        <label class="form-check-label" for="confirm_buy">
                            Je confirme que l'adresse fournie est correcte et que j'ai sélectionné le bon réseau. Toute erreur est de ma responsabilité.
                        </label>
                    </div>
                    
                    <!-- Bouton de soumission -->
                    <div class="d-grid">
                        {{ form.soumettre(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Informations importantes -->
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-exclamation-triangle me-2"></i>Informations importantes
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Frais opérateur: 1.51% (en dessous de 300,000 XAF)</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Frais opérateur: 1% (300,000 XAF à 500,000 XAF)</li>
                    <li class="mb-2"><i class="fas fa-clock text-info me-2"></i>Temps de traitement: 15-30 minutes après confirmation</li>
                    <li><i class="fas fa-headset text-primary me-2"></i>Support disponible en cas de problème</li>
                </ul>
            </div>
        </div>
        
        <!-- Guide de paiement -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Guide de paiement
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">Remplissez le formulaire avec vos informations</li>
                    <li class="mb-2">Un numéro marchand vous sera attribué</li>
                    <li class="mb-2">Effectuez le paiement EXACT du montant indiqué</li>
                    <li class="mb-2">Attendez la confirmation par notre équipe</li>
                    <li>Recevez vos USDT sur l'adresse indiquée</li>
                </ol>
                
                <div class="alert alert-danger mt-3">
                    <i class="fas fa-ban me-2"></i>
                    <strong>Attention :</strong> Tout paiement d'un montant différent sera rejeté et les fonds retenus.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer l'achat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Vous êtes sur le point d'acheter <strong id="confirm-usdt">0.00</strong> USDT pour <strong id="confirm-xaf">0</strong> XAF.</p>
                <p>Le paiement devra être effectué au numéro marchand qui vous sera attribué.</p>
                <p>Confirmez-vous cette transaction ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirm-buy">Confirmer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const montantXafInput = document.getElementById('montant_xaf');
    const tauxVenteInput = document.getElementById('taux_vente');
    const montantUsdtSpan = document.getElementById('montant_usdt');
    const adresseWalletInput = document.getElementById('adresse_wallet');
    const reseauSelect = document.getElementById('reseau');
    const networkHelp = document.getElementById('network-help');
    const buyForm = document.getElementById('buy-form');
    
    // Calcul automatique du montant USDT
    function calculateUSDT() {
        const montantXaf = parseFloat(montantXafInput.value) || 0;
        const tauxVente = parseFloat(tauxVenteInput.value) || 600;
        const montantUsdt = montantXaf / tauxVente;
        montantUsdtSpan.textContent = montantUsdt.toFixed(2);
    }
    
    montantXafInput.addEventListener('input', calculateUSDT);
    
    // Détection automatique du réseau
    adresseWalletInput.addEventListener('input', function() {
        const address = this.value.trim();
        
        if (address.startsWith('T')) {
            reseauSelect.value = 'TRC20';
            networkHelp.textContent = 'Réseau détecté: TRC20 (Tron)';
            networkHelp.className = 'form-text text-success';
        } else if (address.startsWith('0x')) {
            reseauSelect.value = 'ETHEREUM';
            networkHelp.textContent = 'Réseau détecté: Ethereum (ERC20)';
            networkHelp.className = 'form-text text-success';
        } else if (address.length === 44 && /^[A-Za-z0-9]+$/.test(address)) {
            reseauSelect.value = 'SOL';
            networkHelp.textContent = 'Réseau détecté: Solana';
            networkHelp.className = 'form-text text-success';
        } else if (address.toUpperCase().includes('TON')) {
            reseauSelect.value = 'USDT_TON';
            networkHelp.textContent = 'Réseau détecté: USDT_TON';
            networkHelp.className = 'form-text text-success';
        } else if (address.toUpperCase().includes('APT')) {
            reseauSelect.value = 'USDT_APTOS';
            networkHelp.textContent = 'Réseau détecté: USDT_APTOS';
            networkHelp.className = 'form-text text-success';
        } else if (address.length > 0) {
            networkHelp.textContent = 'Réseau non détecté. Sélectionnez manuellement.';
            networkHelp.className = 'form-text text-danger';
        } else {
            networkHelp.textContent = 'Commencez à taper votre adresse pour détecter automatiquement le réseau';
            networkHelp.className = 'form-text';
        }
    });
    
    // Confirmation avant soumission
    buyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const montantXaf = parseFloat(montantXafInput.value) || 0;
        const tauxVente = parseFloat(tauxVenteInput.value) || 600;
        const montantUsdt = montantXaf / tauxVente;
        
        if (montantXaf < 5000 || montantXaf > 500000) {
            alert('Le montant doit être entre 5,000 et 500,000 XAF');
            return;
        }
        
        if (!adresseWalletInput.value.trim()) {
            alert('Veuillez entrer votre adresse de réception USDT');
            return;
        }
        
        // Mettre à jour le modal de confirmation
        document.getElementById('confirm-usdt').textContent = montantUsdt.toFixed(2);
        document.getElementById('confirm-xaf').textContent = montantXaf.toLocaleString('fr-FR');
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
    });
    
    // Confirmation finale
    document.getElementById('confirm-buy').addEventListener('click', function() {
        buyForm.submit();
    });
    
    // Calcul initial
    calculateUSDT();
});
</script>
{% endblock %}