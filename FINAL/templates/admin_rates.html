{% extends "base.html" %}

{% block title %}Gestion des Taux - Admin Devisa-FX{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    .rates-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .rate-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        text-align: center;
    }
    .rate-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    .rate-change {
        font-size: 0.9rem;
    }
    .rate-change.positive {
        color: var(--success-color);
    }
    .rate-change.negative {
        color: var(--accent-color);
    }
    .chart-container {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }
    .rates-table th, .rates-table td {
        vertical-align: middle;
    }
    .action-dropdown {
        min-width: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="user-welcome">Gestion des Taux de Change</h1>
            <p class="text-muted">Configurez et suivez l'évolution des taux USDT/XAF</p>
        </div>
        <div>
            <a href="{{ url_for('admin.export_rates') }}" class="btn btn-outline-primary me-2">
                <i class="fas fa-download me-2"></i>Exporter
            </a>
        </div>
    </div>
</div>

<!-- Résumé des taux actuels -->
<div class="rates-summary">
    <div class="rate-card">
        <h6>Taux d'Achat Actuel</h6>
        {% if taux_aujourdhui %}
        <div class="rate-value text-primary">{{ taux_aujourdhui.taux_achat }} XAF</div>
        <small class="text-muted">Pour 1 USDT</small>
        {% else %}
        <div class="rate-value text-muted">Non défini</div>
        <small class="text-danger">Veuillez définir les taux du jour</small>
        {% endif %}
    </div>
    
    <div class="rate-card">
        <h6>Taux de Vente Actuel</h6>
        {% if taux_aujourdhui %}
        <div class="rate-value text-success">{{ taux_aujourdhui.taux_vente }} XAF</div>
        <small class="text-muted">Pour 1 USDT</small>
        {% else %}
        <div class="rate-value text-muted">Non défini</div>
        <small class="text-danger">Veuillez définir les taux du jour</small>
        {% endif %}
    </div>
    
    <div class="rate-card">
        <h6>Marge Actuelle</h6>
        {% if taux_aujourdhui %}
        {% set ecart = taux_aujourdhui.taux_vente - taux_aujourdhui.taux_achat %}
        {% set marge = (ecart / taux_aujourdhui.taux_achat) * 100 if taux_aujourdhui.taux_achat > 0 else 0 %}
        <div class="rate-value">{{ ecart|round(2) }} XAF</div>
        <div class="rate-change">{{ marge|round(2) }}%</div>
        {% else %}
        <div class="rate-value text-muted">-</div>
        <div class="rate-change text-muted">-</div>
        {% endif %}
    </div>
    
    <div class="rate-card">
        <h6>Moyenne (30 jours)</h6>
        <div class="rate-value">{{ taux_moyen_achat|round(2) }} XAF</div>
        <div class="rate-change">{{ taux_moyen_vente|round(2) }} XAF</div>
        <small class="text-muted">Achat / Vente</small>
    </div>
</div>

<!-- Graphique d'évolution -->
<div class="chart-container">
    <h5 class="mb-4">Évolution des Taux (30 derniers jours)</h5>
    <div style="height: 300px;">
        <canvas id="ratesChart"></canvas>
    </div>
</div>

<!-- Formulaire de mise à jour -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Mettre à jour les Taux</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin.admin_rates') }}" id="ratesForm">
            {{ form.hidden_tag() }}
            
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="taux_achat" class="form-label">Taux d'Achat (XAF/USDT) *</label>
                    {{ form.taux_achat(class="form-control", placeholder="Ex: 590") }}
                    <div class="form-text">Prix auquel nous achetons les USDT</div>
                    {% if form.taux_achat.errors %}
                    <div class="text-danger small">
                        {% for error in form.taux_achat.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="taux_vente" class="form-label">Taux de Vente (XAF/USDT) *</label>
                    {{ form.taux_vente(class="form-control", placeholder="Ex: 610") }}
                    <div class="form-text">Prix auquel nous vendons les USDT</div>
                    {% if form.taux_vente.errors %}
                    <div class="text-danger small">
                        {% for error in form.taux_vente.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="date_application" class="form-label">Date d'Application</label>
                    {{ form.date_application(class="form-control", type="date", min=today.strftime('%Y-%m-%d')) }}
                    <div class="form-text">Par défaut : aujourd'hui</div>
                    {% if form.date_application.errors %}
                    <div class="text-danger small">
                        {% for error in form.date_application.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-3 mb-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save me-2"></i>Mettre à jour
                    </button>
                </div>
            </div>
            
            <!-- Calcul automatique -->
            <div class="alert alert-info">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Écart :</strong> 
                        <span id="ecart-calcul">0 XAF</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Marge :</strong> 
                        <span id="marge-calcul">0%</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Recommandé :</strong> 
                        <span id="recommandation">Écart minimum 20 XAF</span>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Mise à jour rapide (préréglages) -->
        <div class="mt-4">
            <h6>Mise à jour rapide :</h6>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="applyQuickRate(585, 610)">
                    +25 XAF (585/610)
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="applyQuickRate(590, 615)">
                    +25 XAF (590/615)
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="applyQuickRate(595, 620)">
                    +25 XAF (595/620)
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="applyQuickRate(600, 625)">
                    +25 XAF (600/625)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Historique des taux -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historique des Taux</h5>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" style="width: auto;" id="historyFilter">
                <option value="30">30 derniers jours</option>
                <option value="60">60 derniers jours</option>
                <option value="90">90 derniers jours</option>
                <option value="all">Tout l'historique</option>
            </select>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 rates-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Taux Achat</th>
                        <th>Taux Vente</th>
                        <th>Écart</th>
                        <th>Marge</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for taux in historique_taux %}
                    <tr {% if taux.date == today %}class="table-primary"{% endif %}>
                        <td>
                            {{ taux.date.strftime('%d/%m/%Y') }}
                            {% if taux.date == today %}
                            <span class="badge bg-primary">Aujourd'hui</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ taux.taux_achat }} XAF</strong>
                        </td>
                        <td>
                            <strong>{{ taux.taux_vente }} XAF</strong>
                        </td>
                        <td>
                            {% set ecart = taux.taux_vente - taux.taux_achat %}
                            <span class="badge {% if ecart >= 20 %}bg-success{% else %}bg-warning{% endif %}">
                                {{ ecart|round(2) }} XAF
                            </span>
                        </td>
                        <td>
                            {% set marge = (ecart / taux.taux_achat) * 100 if taux.taux_achat > 0 else 0 %}
                            {{ marge|round(2) }}%
                        </td>
                        <td>
                            {% if taux.date < today %}
                            <span class="badge bg-secondary">Historique</span>
                            {% elif taux.date == today %}
                            <span class="badge bg-success">Actif</span>
                            {% else %}
                            <span class="badge bg-info">Futur</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                        type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu action-dropdown">
                                    {% if taux.date != today %}
                                    <li>
                                        <button class="dropdown-item" 
                                                onclick="duplicateRate({{ taux.id }})">
                                            <i class="fas fa-copy me-2"></i>Dupliquer
                                        </button>
                                    </li>
                                    {% endif %}
                                    <li>
                                        <button class="dropdown-item" 
                                                onclick="editRate({{ taux.id }}, {{ taux.taux_achat }}, {{ taux.taux_vente }}, '{{ taux.date.strftime('%Y-%m-%d') }}')">
                                            <i class="fas fa-edit me-2"></i>Modifier
                                        </button>
                                    </li>
                                    {% if taux.date != today %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <button class="dropdown-item text-danger" 
                                                onclick="deleteRate({{ taux.id }})">
                                            <i class="fas fa-trash me-2"></i>Supprimer
                                        </button>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Aucun taux enregistré</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal d'édition -->
<div class="modal fade" id="editRateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier le taux</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editRateForm">
                <input type="hidden" id="edit_rate_id" name="rate_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_taux_achat" class="form-label">Taux d'Achat (XAF)</label>
                        <input type="number" step="0.01" class="form-control" 
                               id="edit_taux_achat" name="taux_achat" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_taux_vente" class="form-label">Taux de Vente (XAF)</label>
                        <input type="number" step="0.01" class="form-control" 
                               id="edit_taux_vente" name="taux_vente" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_date" class="form-label">Date</label>
                        <input type="date" class="form-control" 
                               id="edit_date" name="date" required>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        La modification des taux passés peut affecter les transactions historiques.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de duplication -->
<div class="modal fade" id="duplicateRateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dupliquer le taux</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="duplicateRateForm">
                <input type="hidden" id="duplicate_rate_id" name="rate_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="duplicate_date" class="form-label">Date de duplication</label>
                        <input type="date" class="form-control" 
                               id="duplicate_date" name="nouvelle_date" 
                               min="{{ today.strftime('%Y-%m-%d') }}" required>
                        <div class="form-text">Sélectionnez la date pour appliquer ces taux</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Les taux seront appliqués à la date sélectionnée.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Dupliquer</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Variables globales
let ratesChart = null;

// Calcul automatique de l'écart et de la marge
function calculateRates() {
    const tauxAchat = parseFloat(document.getElementById('taux_achat').value) || 0;
    const tauxVente = parseFloat(document.getElementById('taux_vente').value) || 0;
    
    const ecart = tauxVente - tauxAchat;
    const marge = tauxAchat > 0 ? (ecart / tauxAchat) * 100 : 0;
    
    document.getElementById('ecart-calcul').textContent = ecart.toFixed(2) + ' XAF';
    document.getElementById('marge-calcul').textContent = marge.toFixed(2) + '%';
    
    if (ecart < 20) {
        document.getElementById('recommandation').innerHTML = '<span class="text-danger">Écart trop faible (minimum 20 XAF)</span>';
    } else if (ecart > 50) {
        document.getElementById('recommandation').innerHTML = '<span class="text-warning">Écart élevé, vérifier la compétitivité</span>';
    } else {
        document.getElementById('recommandation').innerHTML = '<span class="text-success">Écart optimal</span>';
    }
}

// Mise à jour rapide des taux
function applyQuickRate(achat, vente) {
    document.getElementById('taux_achat').value = achat;
    document.getElementById('taux_vente').value = vente;
    calculateRates();
}

// Initialiser le graphique
function initChart() {
    const ctx = document.getElementById('ratesChart').getContext('2d');
    
    fetch('/admin/api/rates/history?days=30')
        .then(response => response.json())
        .then(data => {
            if (ratesChart) {
                ratesChart.destroy();
            }
            
            ratesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [
                        {
                            label: 'Taux d\'Achat',
                            data: data.achat,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Taux de Vente',
                            data: data.vente,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Écart',
                            data: data.ecart,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Taux (XAF)'
                            }
                        }
                    }
                }
            });
        });
}

// Éditer un taux
function editRate(rateId, tauxAchat, tauxVente, date) {
    document.getElementById('edit_rate_id').value = rateId;
    document.getElementById('edit_taux_achat').value = tauxAchat;
    document.getElementById('edit_taux_vente').value = tauxVente;
    document.getElementById('edit_date').value = date;
    
    new bootstrap.Modal(document.getElementById('editRateModal')).show();
}

// Dupliquer un taux
function duplicateRate(rateId) {
    document.getElementById('duplicate_rate_id').value = rateId;
    document.getElementById('duplicate_date').value = new Date().toISOString().split('T')[0];
    
    new bootstrap.Modal(document.getElementById('duplicateRateModal')).show();
}

// Supprimer un taux
function deleteRate(rateId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce taux ?')) {
        fetch(`/admin/rates/delete/${rateId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erreur: ' + data.message);
            }
        });
    }
}

// Soumission du formulaire d'édition
document.getElementById('editRateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const rateId = document.getElementById('edit_rate_id').value;
    const formData = new FormData(this);
    
    fetch(`/admin/api/rates/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            taux_achat: formData.get('taux_achat'),
            taux_vente: formData.get('taux_vente'),
            date_application: formData.get('date')
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Erreur: ' + data.message);
        }
    });
});

// Soumission du formulaire de duplication
document.getElementById('duplicateRateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const rateId = document.getElementById('duplicate_rate_id').value;
    const formData = new FormData(this);
    
    fetch(`/admin/rates/duplicate/${rateId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Erreur: ' + data.message);
        }
    });
});

// Filtrer l'historique
document.getElementById('historyFilter').addEventListener('change', function() {
    const days = this.value;
    fetch(`/admin/api/rates/history?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (ratesChart) {
                ratesChart.data.labels = data.dates;
                ratesChart.data.datasets[0].data = data.achat;
                ratesChart.data.datasets[1].data = data.vente;
                ratesChart.data.datasets[2].data = data.ecart;
                ratesChart.update();
            }
        });
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Calcul initial
    calculateRates();
    
    // Écouteurs d'événements pour le calcul automatique
    document.getElementById('taux_achat').addEventListener('input', calculateRates);
    document.getElementById('taux_vente').addEventListener('input', calculateRates);
    
    // Initialiser le graphique
    initChart();
    
    // Configurer la date minimale pour le formulaire principal
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date_application').setAttribute('min', today);
});
</script>
{% endblock %}